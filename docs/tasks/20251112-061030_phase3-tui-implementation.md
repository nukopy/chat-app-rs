# Phase 3: TUI 実装

## 概要

### 目的

ratatui を使用したターミナルベースの UI を実装し、ユーザーフレンドリーなチャットアプリケーションを提供する。

### 背景

- Phase 2 でバックエンド機能（複数ルーム、ユーザー管理、ルーム認証）が実装完了
- 現状は CLI ベースのシンプルなインターフェース
- リッチな TUI により、ユーザー体験を向上させる

### スコープ

- ratatui のセットアップ
- 4 つの画面実装（ルーム一覧、ルーム詳細、パスワード入力、チャット）
- 画面遷移の実装
- キーボード操作の実装
- API/WebSocket 連携

**スコープ外**:

- バックエンド機能の追加（Phase 2 で実施済み）

### 参照

- [前フェーズ: Phase 2 バックエンド拡張](./20251112-061030_phase2-backend-extension.md)
- [ratatui Documentation](https://ratatui.rs/)
- [ratatui Examples](https://github.com/ratatui-org/ratatui/tree/main/examples)

## 方針

### アプローチ

1. ratatui のセットアップ
2. 画面ごとの実装（ルーム一覧 → ルーム詳細 → パスワード入力 → チャット）
3. 画面遷移の実装
4. テストの実装

### 設計方針

#### TUI アーキテクチャ

```txt
┌─────────────────────────────────────┐
│         TUI Application             │
│  ┌───────────────────────────────┐  │
│  │   State Management            │  │
│  │  - current_screen             │  │
│  │  - selected_room              │  │
│  │  - input_buffer               │  │
│  └───────────────────────────────┘  │
│  ┌───────────────────────────────┐  │
│  │   Screen Components           │  │
│  │  - RoomListScreen             │  │
│  │  - RoomDetailScreen           │  │
│  │  - PasswordInputScreen        │  │
│  │  - ChatScreen                 │  │
│  └───────────────────────────────┘  │
│  ┌───────────────────────────────┐  │
│  │   API Client                  │  │
│  │  - HTTP Client                │  │
│  │  - WebSocket Client           │  │
│  └───────────────────────────────┘  │
└─────────────────────────────────────┘
```

#### 画面構成

**1. ルーム一覧画面（トップ画面）**:

```txt
┌─────────────────────────────────────┐
│ Chat Rooms                          │
├─────────────────────────────────────┤
│ > Room A    (3 users) 10:30 AM     │
│   Room B    (1 user)  09:15 AM     │
│   Room C    (5 users) Yesterday    │
├─────────────────────────────────────┤
│ [N] New Room  [Enter] Select        │
└─────────────────────────────────────┘
```

**2. ルーム詳細画面**:

```txt
┌─────────────────────────────────────┐
│ Room: Room A                        │
├─────────────────────────────────────┤
│ Participants: 3                     │
│ Last Activity: 10:30 AM             │
│ Created: 2025-11-11 09:00           │
├─────────────────────────────────────┤
│ [B] Back  [Enter] Join Room         │
└─────────────────────────────────────┘
```

**3. パスワード入力画面**:

```txt
┌─────────────────────────────────────┐
│ Enter Room Password                 │
├─────────────────────────────────────┤
│ Password: ******                    │
├─────────────────────────────────────┤
│ [Enter] Submit  [Esc] Back          │
└─────────────────────────────────────┘
```

**4. チャット画面**:

```txt
┌─────────────────────────────────────┐
│ Room A                 [Esc] Leave  │
├─────────────────────────────────────┤
│ alice: Hello!            10:30:15   │
│ bob: Hi there!           10:30:20   │
│ charlie: How are you?    10:30:25   │
│                                     │
├─────────────────────────────────────┤
│ Participants: alice, bob, charlie   │
├─────────────────────────────────────┤
│ > Hello everyone!_                  │
└─────────────────────────────────────┘
```

#### キーボード操作

- **共通**
  - `Esc`: 前の画面に戻る / アプリ終了
  - `Ctrl+C`: アプリ終了
- **ルーム一覧画面**
  - `↑/↓`: ルーム選択
  - `Enter`: ルーム詳細へ
  - `n`: 新規ルーム作成
- **ルーム詳細画面**
  - `b`: 一覧へ戻る
  - `Enter`: パスワード入力画面へ
- **パスワード入力画面**
  - `文字入力`: パスワード入力
  - `Enter`: 認証実行
  - `Esc`: ルーム詳細へ戻る
- **チャット画面**
  - `↑/↓`: メッセージスクロール
  - `文字入力`: メッセージ入力
  - `Enter`: メッセージ送信
  - `Esc`: ルーム一覧へ戻る

### 品質基準

- 全ての画面に対してユニットテストを実装
- レスポンシブなレイアウト（ターミナルサイズに対応）
- キーボード操作の一貫性
- エラーハンドリングの実装

## タスク

### ratatui のセットアップ

- [ ] 依存関係の追加
  - [ ] Cargo.toml に ratatui を追加
  - [ ] Cargo.toml に crossterm を追加
  - [ ] Cargo.toml に tokio（async runtime）を追加

- [ ] 基本的な TUI アプリケーション構造の実装
  - [ ] Terminal の初期化・復元
  - [ ] イベントループの実装
  - [ ] 状態管理の実装
  - [ ] テストの実装

### ルーム一覧画面の実装

- [ ] レイアウト設計
  - [ ] ヘッダーの実装
  - [ ] ルームリストの実装
  - [ ] フッター（操作ガイド）の実装

- [ ] ルームリストの表示
  - [ ] API からルーム一覧を取得
  - [ ] ルーム情報のフォーマット（名前、参加者数、最終更新日時）
  - [ ] スクロール機能の実装

- [ ] キーボード操作
  - [ ] 上下キーでのルーム選択
  - [ ] Enter キーでルーム詳細へ遷移
  - [ ] `n` キーで新規ルーム作成ダイアログ表示

- [ ] API 連携
  - [ ] HTTP Client の実装（`GET /api/rooms`）
  - [ ] レスポンスのパース
  - [ ] エラーハンドリング

- [ ] テスト
  - [ ] レイアウトのテスト
  - [ ] キーボード操作のテスト
  - [ ] API 連携のテスト（モック使用）

### ルーム詳細画面の実装

- [ ] レイアウト設計
  - [ ] ヘッダー（ルーム名）の実装
  - [ ] ルーム情報表示エリアの実装
  - [ ] フッター（操作ガイド）の実装

- [ ] ルーム情報の表示
  - [ ] 参加者数の表示
  - [ ] 最終アクティビティの表示
  - [ ] 作成日時の表示

- [ ] キーボード操作
  - [ ] `b` キーで一覧へ戻る
  - [ ] Enter キーでパスワード入力画面へ遷移

- [ ] API 連携
  - [ ] HTTP Client の実装（`GET /api/rooms/:room_id`）
  - [ ] レスポンスのパース
  - [ ] エラーハンドリング

- [ ] テスト
  - [ ] レイアウトのテスト
  - [ ] キーボード操作のテスト
  - [ ] API 連携のテスト（モック使用）

### パスワード入力画面の実装

- [ ] レイアウト設計
  - [ ] ヘッダーの実装
  - [ ] パスワード入力フォームの実装
  - [ ] フッター（操作ガイド）の実装

- [ ] パスワード入力フォーム
  - [ ] マスク表示（`******`）の実装
  - [ ] 入力バッファの管理
  - [ ] バリデーション（6 文字）

- [ ] 認証処理
  - [ ] Enter キーで認証実行
  - [ ] 認証成功でチャット画面へ遷移
  - [ ] 認証失敗でエラーメッセージ表示

- [ ] キーボード操作
  - [ ] 文字入力
  - [ ] Backspace での削除
  - [ ] Enter キーで認証実行
  - [ ] Esc キーでルーム詳細へ戻る

- [ ] API 連携
  - [ ] HTTP Client の実装（`POST /api/rooms/:room_id/auth`）
  - [ ] レスポンスのパース
  - [ ] エラーハンドリング

- [ ] テスト
  - [ ] レイアウトのテスト
  - [ ] 入力フォームのテスト
  - [ ] 認証処理のテスト（モック使用）

### チャット画面の実装

- [ ] レイアウト設計
  - [ ] ヘッダー（ルーム名、退出ボタン）の実装
  - [ ] メッセージ一覧エリアの実装
  - [ ] 参加者一覧エリアの実装
  - [ ] メッセージ入力エリアの実装

- [ ] メッセージ表示
  - [ ] メッセージリストの表示
  - [ ] 自動スクロール（新規メッセージ）
  - [ ] 手動スクロール機能
  - [ ] タイムスタンプの表示

- [ ] メッセージ入力
  - [ ] 入力バッファの管理
  - [ ] Enter キーでメッセージ送信
  - [ ] 送信後の入力バッファクリア

- [ ] 参加者一覧
  - [ ] 参加者リストの表示
  - [ ] 参加者の入退室通知の反映

- [ ] WebSocket 連携
  - [ ] WebSocket 接続の確立
  - [ ] メッセージ受信
  - [ ] メッセージ送信
  - [ ] 参加者通知の受信
  - [ ] 切断処理

- [ ] キーボード操作
  - [ ] 上下キーでメッセージスクロール
  - [ ] 文字入力でメッセージ入力
  - [ ] Enter キーでメッセージ送信
  - [ ] Esc キーでルーム一覧へ戻る

- [ ] テスト
  - [ ] レイアウトのテスト
  - [ ] メッセージ表示のテスト
  - [ ] 入力処理のテスト
  - [ ] WebSocket 連携のテスト（モック使用）

### 画面遷移の実装

- [ ] 状態管理の実装
  - [ ] 現在の画面状態の管理
  - [ ] 選択中のルーム情報の管理
  - [ ] 入力バッファの管理

- [ ] 画面遷移ロジックの実装
  - [ ] ルーム一覧 → ルーム詳細
  - [ ] ルーム詳細 → パスワード入力
  - [ ] パスワード入力 → チャット
  - [ ] パスワード入力 → ルーム詳細（戻る）
  - [ ] チャット → ルーム一覧（退出）

- [ ] エラーハンドリング
  - [ ] API エラーの表示
  - [ ] WebSocket 切断時の処理
  - [ ] ネットワークエラーの表示

- [ ] テスト
  - [ ] 画面遷移のテスト
  - [ ] エラーハンドリングのテスト

### 統合テスト

- [ ] エンドツーエンドテスト
  - [ ] ルーム一覧の表示
  - [ ] ルーム選択からチャット画面への遷移
  - [ ] メッセージ送受信
  - [ ] 退出処理

- [ ] エラーシナリオのテスト
  - [ ] API エラー時の動作
  - [ ] 認証失敗時の動作
  - [ ] WebSocket 切断時の動作

## 進捗状況

- **作成日**: 2025-11-12 06:10:30
- **開始日**: 未定（Phase 2 完了後）
- **現在のフェーズ**: Phase 3 - TUI 実装
- **完了タスク数**: 0 / 55
- **次のアクション**: Phase 2 の完了を待つ
- **ブロッカー**: Phase 2 の完了

## 備考

### 実装時の注意事項

1. **ターミナルサイズへの対応**
   - 最小サイズ要件を定義（例: 80x24）
   - レスポンシブなレイアウト

2. **パフォーマンス**
   - メッセージリストの効率的なレンダリング
   - 大量のメッセージへの対応（仮想スクロール）

3. **ユーザビリティ**
   - 一貫したキーボード操作
   - 明確な操作ガイドの表示
   - エラーメッセージの分かりやすさ

4. **既存 CLI との共存**
   - 既存の CLI クライアントも維持
   - TUI は別バイナリとして実装（`cargo run --bin tui-client`）

### テスト戦略

- 画面コンポーネントの単体テスト
- キーボード操作のテスト
- API/WebSocket 連携のテスト（モック使用）
- エンドツーエンドテスト（実際のサーバーに接続）

### 将来の拡張

- マウス操作のサポート
- テーマのカスタマイズ
- メッセージの検索機能
- 通知機能（新規メッセージ）

## 参考資料

### ratatui 関連

- [ratatui Documentation](https://ratatui.rs/)
- [ratatui Examples](https://github.com/ratatui-org/ratatui/tree/main/examples)
- [crossterm Documentation](https://docs.rs/crossterm/)

### TUI デザイン

- [TUI Design Patterns](https://github.com/ratatui-org/ratatui/blob/main/DESIGN.md)
- [ASCII Art for TUI](https://www.asciiart.eu/)

### 関連ドキュメント

- [Phase 2 バックエンド拡張](./20251112-061030_phase2-backend-extension.md)
- [ソフトウェアアーキテクチャ](../documentations/software-architecture.md)
